%!TEX root = main.tex

% Sampling Section of negFE

 \begin{lemma}
 \label{lem:close family}
Fix $n, t, k, \gamma  \in \mathbb{Z}^+$ where $t<n/2$, then
$\Delta(\wnkz, \pcodeuz) \le \left(e2^{\gamma-\beta}\right)^{2^{k-\gamma}}2^n.$
\end{lemma}

\begin{proof}[Proof of Lemma~\ref{lem:close family}]
We first show the fraction of items in $\znkset$ that are not in $\pcodeset$ is at most $\left(e2^{\gamma-\beta}\right)^{2^{k-\gamma}}2^n$.  
A string $z\in \znkset\setminus \pcodeset$ if and only if there exists some point $y$ such that there are at least $2^{-\gamma}2^k = 2^{k-\gamma}$ points within distance $t$ of $y$.  Fix some arbitrary $y^*$. The point $y^*$ defines a set $A_{y^*}$ of all points within distance $t$ and note that $|A_{y^*}| = |B_t|$.  We now show that the probability that a value in $z\leftarrow \znk$ has a large intersection with $A_{y^*}$ is small.  

  \begin{claim}
  \label{clm:chernoff independence}
  Let $n,k,a\in\mathbb{Z}^+$ where $\log a < k$.  Let $a^* = a/(1 - a2^{-k})$. Let $\znk$
  be the uniform distribution over $\znkset$. Let $A$ be a fixed subset of size $a \cdot 2^{n-k}$. Then
  $\Exp[|\znk \cap A|] = a$ and any $\zeta > 0$,
  \[
    \Pr[|\znk \cap A| \geq a^*(1 + \zeta)] \leq \left[\frac{e^\zeta}{(1+\zeta)^{1+\zeta}}\right]^{a^*}\,.
  \]
\end{claim}
\begin{proof}
  For the purposes of bookkeeping, arrange the elements of $A$ in an
  arbitrary order and note that $|A| = a2^{n-k} < 2^k2^{n-k} = 2^n$ so $A\subset \{0,1\}^n$, and let
  \[
    X_1, \ldots, X_{a2^{n-k}}
  \]
  be indicator random variables so that $X_i = 1$ if and only if the
  $i$th element of $A$ lies in $\znk$.  Note that for any individual $i$, $\Pr[X_i =1] =a2^{n-k}/2^n = a2^{-k}$ and thus $\expe[|\znk\cap A|] =\sum_i \expe[X_i] = 2^k \expe[X_i] =2^k (a2^{-k})= a$ by linearity of expectation.  Observe that under any conditioning on the
  variables $X_1, \ldots, X_t$,
  \[
    \Pr[X_{t+1} = 1] \leq \frac{2^k}{2^n - a2^{n-k}} = \frac{2^k}{2^n(1 - a2^{-k})}\,.
  \]
   Let $Y_i$ be a sequence of
  i.i.d.\ random variables (with the same index set) for which
  \[
    \Pr[Y_i = 1] = \frac{2^{k}}{2^n(1 - a2^{-k})}\,.
  \]It follows that the random variable $\sum_i X_i$ is stochastically
  dominated by the random variable $\sum_i Y_i$. Observe that
  $\Exp[\sum Y_i] = a^*$. Applying a standard Chernoff upper tail
  bound to the $Y_i$ then yields the result. This completes the proof of Claim~\ref{clm:chernoff independence}.
\end{proof}

\noindent
We now continue using the notation of Claim~\ref{clm:chernoff independence}, let 
\[
a^* =\frac{2^k|B_t|}{2^n - |B_t|}=2^{k-\beta}.
\]
Fix the value of $\zeta$ such that 
\[1+\zeta = \frac{2^{-\gamma}(2^n - |B_t|)}{|B_t|} \ge 2^{\beta-\gamma}. \]
then the probability $\znk$ intersects with $A_{y^*}$ in at least $2^{k-\gamma}$ places is at most 
\begin{align*}
\Pr[|\znk \cap A_{y^*}| \ge a^*(1+\zeta)] &\le \\
\Pr[| \znk \cap A_{y^*} | \ge 2^{k-\gamma}] &\le \left(\left(e2^{\gamma-\beta}\right)^{2^{\beta-\gamma}}\right)^{2^{k-\beta}} \\&= \left(e2^{\gamma-\beta}\right)^{2^{k-\gamma}}
\end{align*}
Now we consider a union bound across all $y^*$.  That is
\[
\Pr_{z\leftarrow\znk }[\Hfuzz(W_z)\ge \gamma] = \left(e2^{\gamma-\beta}\right)^{2^{k-\gamma}}2^n.
\]

The difference between $\wnkz$ and $\pcodeuz$ is exactly the set of $z\in\znkset$ that are not present in $\pcodeset$.  This probability mass is uniformly distributed in both cases, thus 
\[
\Delta(\wnkz, \pcodeuz) \le \left(e2^{\gamma-\beta}\right)^{2^{k-\gamma}}2^n.
\]
completing the proof of Lemma~\ref{lem:close family}.
\end{proof}

